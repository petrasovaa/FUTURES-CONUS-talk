<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Parallelization Tips for Geoprocessing with GRASS GIS</title>

        <meta name="description" content="FOSS4G2022_talk">
        <meta name="author" content="Anna Petrasova">

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="css/theme/osgeo.css" id="theme">
        <link rel="stylesheet" href="css/nouislider.min.css" id="slide">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
        <!-- For chalkboard plugin -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = 'css/print/pdf.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

<!--        <link href="https://fonts.googleapis.com/css?family=Miriam+Libre" rel="stylesheet">-->
<style>
/* miriam-libre-regular - latin */
@font-face {
  font-family: 'Miriam Libre';
  font-style: normal;
  font-weight: 400;
  src: url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.eot'); /* IE9 Compat Modes */
  src: local('Miriam Libre'), local('MiriamLibre-Regular'),
       url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-regular.svg#MiriamLibre') format('svg'); /* Legacy iOS */
}

/* miriam-libre-700 - latin */
@font-face {
  font-family: 'Miriam Libre';
  font-style: normal;
  font-weight: 700;
  src: url('lib/font/miriam-libre/miriam-libre-v1-latin-700.eot'); /* IE9 Compat Modes */
  src: local('Miriam Libre Bold'), local('MiriamLibre-Bold'),
       url('lib/font/miriam-libre/miriam-libre-v1-latin-700.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-700.woff2') format('woff2'), /* Super Modern Browsers */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-700.woff') format('woff'), /* Modern Browsers */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-700.ttf') format('truetype'), /* Safari, Android, iOS */
       url('lib/font/miriam-libre/miriam-libre-v1-latin-700.svg#MiriamLibre') format('svg'); /* Legacy iOS */
}


/* sintony-regular - latin */
@font-face {
  font-family: 'Sintony';
  font-style: normal;
  font-weight: 400;
  src: url('lib/font/sintony/sintony-v4-latin-regular.eot'); /* IE9 Compat Modes */
  src: local('Sintony'),
       url('lib/font/sintony/sintony-v4-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('lib/font/sintony/sintony-v4-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('lib/font/sintony/sintony-v4-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('lib/font/sintony/sintony-v4-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('lib/font/sintony/sintony-v4-latin-regular.svg#Sintony') format('svg'); /* Legacy iOS */
}

/* sintony-700 - latin */
@font-face {
  font-family: 'Sintony';
  font-style: normal;
  font-weight: 700;
  src: url('lib/font/sintony/sintony-v4-latin-700.eot'); /* IE9 Compat Modes */
  src: local('Sintony Bold'), local('Sintony-Bold'),
       url('lib/font/sintony/sintony-v4-latin-700.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('lib/font/sintony/sintony-v4-latin-700.woff2') format('woff2'), /* Super Modern Browsers */
       url('lib/font/sintony/sintony-v4-latin-700.woff') format('woff'), /* Modern Browsers */
       url('lib/font/sintony/sintony-v4-latin-700.ttf') format('truetype'), /* Safari, Android, iOS */
       url('lib/font/sintony/sintony-v4-latin-700.svg#Sintony') format('svg'); /* Legacy iOS */
}

.reveal li > ul {
    font-size: 85%;
    line-height: 110%;
  }

.reveal small {
  display: inline-block;
  font-size: smaller;
  line-height: 1.2em;
  vertical-align: baseline;
  margin: 0.1em; }

.reveal small * {
  vertical-align: baseline; }

.reveal .credit {
  font-size: small;
  color: gray;
  margin: 0.1em;
}

.reveal .right, .reveal .textimg > img, .reveal .textimg > video, .reveal .textimg > iframe, .reveal .imgtext > p, .reveal .imgtext > ul, .reveal .imgtext > ol, .reveal .imgtext > div {
    float: right;
    text-align: left;
    max-width: 47%;
}

.reveal .left, .reveal .imgtext > img, .reveal .imgtext > video, .reveal .imgtext > iframe, .reveal .textimg > p, .reveal .textimg > ul, .reveal .textimg > ol, .reveal .textimg > div {
    float: left;
    text-align: left;
    max-width: 47%;
}
.flexcontainer {
  display: flex;
  width: 100%;
  /* padding: 16% 2%; */
  box-sizing: border-box;
  /* height: 5vh; */
  flex-wrap: wrap;
}

.flexbox {
  flex: 1;
  flex: 1 0 17%; 
  overflow: hidden;
  transition: .5s;
  margin: 0 4%;
  box-shadow: 0 20px 30px rgba(0,0,0,.1);
  line-height: 0;
}

.flexbox > img {
  width: 90%;
  height: 60%;
  object-fit: cover;
  margin: 0% 0%;
  transition: .5s;
}

.flexbox > span {
  font-size: 70%;
  display: block;
  text-align: center;
  /* height: 2.5vh; */
  line-height: 0.9;
}

mark {
    background-color: #fdf4a0;
}

</style>


    </head>
    <body>
        <div class="reveal">
            <div class="slides">


<!-- GRASS GIS is a well established geoprocessing engine with Python interface,
     command line, GUI, and REST API. Although GRASS GIS has been used for big
      data processing for a while now, speeding up GRASS workflows has become
       easier with several newly parallelized tools, better API, and benchmarking
        library. The purpose of this talk is to explain foundational concepts,
      such as parallel efficiency, and scaling, and what their implications
     are for geoprocessing and efficient use of computational resources.
     We will review the state of parallelization of GRASS GIS including
     tools supporting multithreading and multiprocessing and their
      benchmarks. For more complex geoprocessing workflows, I will 
       demonstrate simple approaches for speeding up your computation
       that are applicable whether you are working on your laptop or HPC.
     This talk is for all levels of expertise, although basic Python or GRASS GIS
      knowledge will be advantageous. -->
<section>
    <h1>Parallelization Tips for</h1>
    
    <h1 style="margin-bottom: 1.5em">Geoprocessing with GRASS GIS</h1>
    <img src="img/grass_logo_multiple.png" width="80%">
    <p style="margin-top: 1.5em">
        Anna Petrasova, Vaclav Petras
    </p>
    <p class="title-foot">
        <a href="http://geospatial.ncsu.edu/geoforall/" title="NCSU GeoForAll Lab">NCSU GeoForAll Lab</a>
        at the
        <a href="http://geospatial.ncsu.edu/" title="NCSU Center for Geospatial Analytics">Center for Geospatial Analytics</a>
        <br>
        <a href="http://www.ncsu.edu/" title="NC State University">NC State University</a>
    </p>
    <aside class="notes">
        Good afternoon, in this presentation I will talk about parallelization techniques in GRASS
         I used in my application, which is computing large scale urban growth projections.

    </aside>
</section>


<section>
<h2>Anna Petrasova</h2>
<ul>
    <!-- <li>BS &amp; MS in Geoinformatics, Czech Technical University in Prague
    <li>PhD in Geospatial Analytics, NC State -->
    <img class="bio-img" src="img/bio.jpg" alt="Pic of Anna Petrasova">
    <li>Geospatial Research Software Engineer at the Center for Geospatial Analytics, NC State University
    <li>GRASS GIS Development Team Member
    <li>GRASS GIS Project Steering Committee Member
    <li>Open Source Geospatial Foundation Charter Member
</ul>
<aside class="notes">
    Just a brief introduction, my name is Anna Petrasova and I develop research software at the Center for Geospatial Analytics
    at NCSU. I am a GRASS GIS user and developer.
</aside>
</section>

<section>
    <h2>What is GRASS GIS?</h2>
    <p>Open-source desktop GIS</p>
    <img src="img/gui_pink_viewshed.png" class="stretch">
    
</section>

<section>
    <h2>What is GRASS GIS?</h2>
    <p>Processing backend in QGIS</p>
    <img src="https://media.githubusercontent.com/media/baharmon/baharmon.github.io/master/images/governors-island/grass-in-qgis.jpg" class="stretch">
    <small>Image source: <a href="https://baharmon.github.io/grass-in-qgis">baharmon.github.io/grass-in-qgis</a></small>
    
</section>
<section>
    <h2>What is GRASS GIS?</h2>
    <p>Geospatial data analytics tool in RStudio</p>
    <img src="https://veroandreo.github.io/grass_opengeohub2021/assets/img/RwithinGRASS_and_Rstudio_from_grass.png" class="stretch">
    <small>Image source: <a href="veroandreo.github.io/grass_opengeohub2021/presentation.html">https://veroandreo.github.io/grass_opengeohub2021/presentation.html</a></small>
</section>
<section>
    <h2>What is GRASS GIS?</h2>
    <p>Geovisualization and data analytics tool in a Python notebook</p>
    <img src="img/jupyter3.png" class="stretch">
</section>
<section>
    <h2>What is GRASS GIS?</h2>
    <p>Geoprocessing engine running in HPC environment</p>
    <img src="img/HPC_interaction.png" class="stretch">
    
</section>
<section>
    <h2>What is GRASS GIS?</h2>
    <p>Geospatial platform for developing custom models</p>
    <img src="img/programming_FUTURES.png" class="stretch">
</section>
<section>
    <h2>What is GRASS GIS?</h2>
    <p>Cloud geoprocessing backend</p>
    <img src="https://neteler.gitlab.io/actinia-introduction/img/actinia_architecture_FTTH.png" class="stretch">
    <small>Image source: <a href="https://neteler.gitlab.io/actinia-introduction/">neteler.gitlab.io/actinia-introduction/</a></small>
</section>




<section>
    <h2>Parallelization in GRASS: Start simple</h2>
    
    <div >
    <!-- <p> Tool-level parallelization -->
        <br>
        <pre><code data-trim data-noescape>r.neighbors input=elevation output=elevation_smoothed size=15 <mark> nprocs=4</mark></code></pre>
        <img src="img/neighbors_example.png" width="100%", style="margin: 0px">
    </div>
    <aside class="notes">
        When we talk about parallelization in GIS, I think it's helpful to
        distinguish between tool-level parallelization and workflow-level
        parallelization.
        ...
        When you consider an entire GIS workflow, you may be able to parallelize it
        even when the individual tools are not parallelized internally.

        
    </aside>
</section>
<section>
    <h2>Tools with parallel support</h2>
    <div class="flexcontainer">
        <div class="flexbox">
            <img src="img/module_rslopeaspect.png">
            <span>r.slope.aspect</span>
          </div>
        <div class="flexbox">
          <img src="img/module_rneighbors.png">
          <span>r.neighbors</span>
        </div>
        <div class="flexbox">
          <img src="img/module_rmfilter.png">
          <span>r.mfilter</span>
        </div>
        <div class="flexbox">
          <img src="img/module_rseries.png">
          <span>r.series</span>
        </div>
        <div class="flexbox">
            <img src="img/module_rpatch.png">
            <span>r.patch</span>
        </div>
        <div class="flexbox">
            <img src="img/module_rsun.png">
            <span>r.sun</span>
        </div>
        <div class="flexbox">
            <img src="img/module_vsurfrst.png">
            <span>v.surf.rst</span>
        </div>
        <div class="flexbox">
            <img src="img/module_rsimwater.png">
            <span>r.sim.water</span>
        </div>
        <div class="flexbox">
            <img src="img/module_rsimsediment.png">
            <span>r.sim.sediment</span>
        </div>
        <div class="flexbox">
          <img src="img/module_rneighbors.png">
          <span>r.resamp.interp</span>
        </div>
        <div class="flexbox">
          <img src="img/module_rmfilter.png">
          <span>r.resamp.filter</span>
        </div>
        <div class="flexbox">
            <img src="img/module_runivar.png">
            <span>r.univar</span>
          </div> 
      </div>
<br>
      <small>And more at <a href="https://grass.osgeo.org/grass-stable/manuals/keywords.html#parallel">
        grass.osgeo.org/grass-stable/manuals/keywords.html#parallel</a></small>

</section>


<section>
    <h2>See manual pages for benchmarks</h2>

    <div class="flexcontainer">
        <div class="flexbox">
            <a href="https://grass.osgeo.org/grass-stable/manuals/r.series.html">
          <img src="https://grass.osgeo.org/grass-stable/manuals/r_series_benchmark_size.png">
        </a>
          <span>r.series</span>
        </div>
        <div class="flexbox">
            <a href="https://grass.osgeo.org/grass-stable/manuals/r.patch.html">
          <img src="https://grass.osgeo.org/grass-stable/manuals/r_patch_benchmark_size.png">
        </a>
          <span>r.patch</span>
        </div>
        <div class="flexbox">
            <a href="https://grass.osgeo.org/grass-stable/manuals/r.neighbors.html">
          <img src="https://grass.osgeo.org/grass-stable/manuals/r_neighbors_benchmark_nprocs.png">
        </a>
          <span>r.neighbors </span>
        </div> 
    </div>
      <br><br>

      <p style="vertical-align: center;">
        <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px">
        <!-- <span style="font-size: 150%">&#10152</span> -->
         Use 4 cores to get most speed improvements with high parallel efficiency.
         <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px"></p>
        
</section>
<section>
    <h2>Workflow-level parallelization</h2>
    <p> Run multiple independent tasks in the background<br>
        <pre><code data-trim data-noescape>
            r.grow.distance input=roads distance=dist_to_roads &
            r.grow.distance input=water distance=dist_to_water &
            r.grow.distance input=forest distance=dist_to_forest &
        </code></pre>
        <img src="img/distance_example.png" width="100%", style="margin: 0px">
    </section>

    <section>
    <h2>Workflow-level parallelization</h2>
    <p>Run tasks with GNU Parallel (or alternatives)
    <pre><code data-trim data-noescape>
        echo r.grow.distance input=roads distance=dist_to_roads > jobs.txt
        echo r.grow.distance input=water distance=dist_to_water >> jobs.txt
        echo r.grow.distance input=forest distance=dist_to_forest >> jobs.txt
        parallel --jobs 3 < jobs.txt
    </code></pre></p>
    <br>
    <div class="fragment"><p>Run "hybrid" tasks:
    <pre><code data-trim data-noescape>
        r.neighbors input=forest output=forest_percentage size=37 nprocs=4 &
        r.neighbors input=wetland output=wetland_percentage size=37 nprocs=4 &
    </code></pre></p></div>
</section>

<section>
    <h2>Tiling approach</h2>
    <pre><code data-trim data-noescape>
    from grass.pygrass.modules.grid import GridModule

    grd = GridModule("v.to.rast", input="roads", output="roads",
                     use="val", processes=4)
    grd.run()
    </code></pre>
    <pre><code data-trim data-noescape>
    r.mapcalc.tiled "log_dist = if (dist == 0, 0, log(dist))" nprocs=4
    </code></pre>
    <img src="img/tiling2.png" class="stretch">
</section>
<section>
    <img src="img/exp1.png" class="stretch">
</section>

<section>
        <h2>Let's do some Python scripting</h2>
        <ul>
            <li><em>multiprocessing</em>, <em>concurrent.futures</em> packages</li>
            <li>Use case: calling GRASS tools and workflows in parallel</li>
        </ul>
        <pre><code data-trim data-noescape data-line-numbers="1,6,7">
            from multiprocessing import Pool
    
            def compute(value):
                # do something with the value
    
            with Pool(processes=4) as pool:
                pool.map(compute, range(0, 10))
        </code></pre>

        Used in r.sun.daily, r.in.usgs, t.rast.what, r.viewshed.exposure, ...
</section>


<!-- <section data-background-image="img/inundation.gif" data-background-opacity="0.3">
        <h2>Example: increasing water level</h2>
        <pre><code data-trim data-noescape>
            from multiprocessing import Pool
            import grass.script as gs
    
            def inundate(level):
                name = f"inundation_{level}"
                gs.run_command("r.lake", elevation="elevation", lake=name,
                               seed="seed", water_level=level)
                return name
    
            with Pool(processes=4) as pool:
                maps = pool.map(inundate, range(0, 10))
        </code></pre>
        <ul style="list-style: none;">
        <li>&#10004; independent computations</li>
        <li>&#10004; different output names</li>
        </ul>
</section> -->

<section data-background-image="img/viewsheds.gif" data-background-opacity="0.7">
    <!-- <section data-background-image="https://baharmon.github.io/images/governors-island/flooding.gif" data-background-opacity="0.4"> -->
        <h2>Example: multiple viewsheds</h2>
        <pre><code data-trim data-noescape>
        from multiprocessing import Pool
        import grass.script as gs
    
        def viewshed(point):
            x, y, cat = point
            name = f"viewshed_{cat}"
            gs.run_command("r.viewshed", input="elevation", output=name,
                           coordinates=(x, y))
            return name
    
        # viewpoints = [(x1, y1, category1), (x2, y2, category2), ...]
        with Pool(processes=4) as pool:
            maps = pool.map(viewshed, viewpoints)
        </code></pre>
        <ul style="list-style: none;">
        <li>&#10004; independent computations</li>
        <li>&#10004; different output names</li>
        <li>&#10004; same computational region</li>
        </ul>
</section>

<section data-transition="none" data-background-image="img/viewsheds.gif"
 data-background-opacity="0.7">
    <h2><img src="img/lightbulb.png" style="width: 1.5em;margin: 0px">
        Tasks with different region
        <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px"></h2>
    <pre><code data-trim data-noescape data-line-numbers>
        import os
        from multiprocessing import Pool
        import grass.script as gs
        
        def viewshed(point):
            x, y, cat = point
            name = f"viewshed_{cat}"
            os.environ["GRASS_REGION"] = gs.region_env(e=x + 300, w=x - 300,
                                                       n=y + 300, s=y - 300,
                                                       align="elevation")
            gs.run_command("r.viewshed", input="elevation", output=name,
                           coordinates=(x, y), max_distance=300)
            return name
        
        # viewpoints = [(x1, y1, category1), (x2, y2, category2), ...]
        with Pool(processes=4) as pool:
            maps = pool.map_async(viewshed, viewpoints).get()
    </code></pre>
</section>
<section data-transition="none" data-background-image="img/viewsheds.gif" data-background-opacity="0.7">
    <h2><img src="img/lightbulb.png" style="width: 1.5em;margin: 0px">
        Tasks with different region
        <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px"></h2>
    <pre><code data-trim data-noescape data-line-numbers="8-10">
        import os
        from multiprocessing import Pool
        import grass.script as gs
        
        def viewshed(point):
            x, y, cat = point
            name = f"viewshed_{cat}"
            os.environ["GRASS_REGION"] = gs.region_env(e=x + 300, w=x - 300,
                                                       n=y + 300, s=y - 300,
                                                       align="elevation")
            gs.run_command("r.viewshed", input="elevation", output=name,
                           coordinates=(x, y), max_distance=300)
            return name
        
        # viewpoints = [(x1, y1, category1), (x2, y2, category2), ...]
        with Pool(processes=4) as pool:
            maps = pool.map_async(viewshed, viewpoints).get()
    </code></pre>
</section>

<section>
    <!-- <section data-background-image="https://baharmon.github.io/images/governors-island/flooding.gif" data-background-opacity="0.4"> -->
        <h2><img src="img/lightbulb.png" style="width: 1.5em;margin: 0px">
            Progress bar
            <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px"></h2>
        <pre><code data-trim data-noescape data-line-numbers="1,14-15">
        from tqdm import tqdm
        from multiprocessing import Pool
        import grass.script as gs
    
        def viewshed(point):
            x, y, cat = point
            name = f"viewshed_{cat}"
            gs.run_command("r.viewshed", input="elevation", output=name,
                           coordinates=(x, y))
            return name
    
        # viewpoints = [(x1, y1, category1), (x2, y2, category2), ...]
        with Pool(processes=4) as pool:
            maps = list(tqdm(pool.imap(viewshed, viewpoints),
                             total=len(viewpoints)))
        </code></pre>
        <img src="img/tqdm.gif">
</section>
<!-- <section data-transition="none" data-background-image="img/viewsheds.gif" data-background-opacity="0.7">
    <h2>Multiple tasks with different region</h2>
    <pre><code data-trim data-noescape data-line-numbers="8-13">
        import os
        from multiprocessing import Pool
        import grass.script as gs
        
        def viewshed(point):
            x, y, cat = point
            name = f"viewshed_{cat}"
            <mark>env</mark> = os.environ.copy()
            <mark>env</mark>["GRASS_REGION"] = gs.region_env(e=x + 300, w=x - 300,
                                                n=y + 300, s=y - 300,
                                                align="elevation")
            gs.run_command("r.viewshed", input="elevation", output=name,
                           coordinates=(x, y), max_distance=300, <mark>env=env</mark>)
            return name
        
        # viewpoints = [(x1, y1, category1), (x2, y2, category2), ...]
        with Pool(processes=4) as pool:
            maps = pool.map_async(viewshed, viewpoints).get()
    </code></pre>
</section> -->

<!-- <section>
    <h2>Multiprocessing in Jupyter Notebooks</h2>
    This may not work from Jupyter Notebook:
   <img src="img/jupyter1.png" class="stretch">
</section>
<section>
    <h2>Multiprocessing in Jupyter Notebooks</h2>
    
   <img src="img/jupyter2.png" class="stretch">
</section>

<section>
    <img src="img/nextlevel1.png" class="stretch">
</section> -->

<section>
    <img src="img/exp2.png" class="stretch">
</section>

<section>
    <h2>Multi-threading with OpenMP</h2>
    <ul>
        <li>parallelization of geospatial algorithms in C</li>
        <li>shared memory</li>
        <li>relatively easy integration into existing source code</li>
        <li>single code base for all platforms</li>
    </ul>
<pre><code data-trim data-noescape data-line-numbers="1,4,6">
#pragma omp parallel if(threaded) private(row, col, i)
    {
        int t_id = 0;
#if defined(_OPENMP)
        t_id = omp_get_thread_num();
#endif
        struct input *in = inputs[t_id];
        DCELL *val = values[t_id];
        ...
        </code></pre>
    <aside class="notes">
        So first let's look at tool-level parallelization in GRASS. There are 2 ways,
        either multi-threading with OpenMP, or multi-processing with Python.
    </aside>
<!-- <p> Beware race conditions, valgrind is your friend. -->
</section>

<section>
    <h2>grass.benchmark library</h2>
    <pre><code data-trim data-noescape>
from grass.benchmark import benchmark_nprocs, nprocs_plot
from grass.pygrass.modules import Module

module = Module("r.neighbors", input="DEM", size=9, output="benchmark",
                run_=False, overwrite=True)
result = benchmark_nprocs(module, label="size 3", max_nprocs=12, repeat=3)
nprocs_plot([result], filename="benchmark.svg")
</code></pre>
<img src="img/openmp_graph.png" class="stretch">
</section>

<section>
    <h2>Example: r.neighbors</h2>
    
    <img src="https://grass.osgeo.org/grass-stable/manuals/r_neighbors.png">
    <small>Image source: r.neighbors manual page</small>
    <br><br><br>
    <p> Focal (neighborhood) operations on a raster</p>
    
        
</section>

<section>
    <h2>r.neighbors benchmark <span style="font-size:60%">400 million cells</span></h2>
    <p style="font-size:60%">\[\mbox{parallel efficiency} = \frac{\mbox{serial processing time}}{N \times \mbox{parallel processing time with N cores}} \]</p>
    <img src="img/benchmark.svg" class="stretch">
    <p style="vertical-align: center;">
        <!-- <span style="font-size: 150%">&#10152</span> -->
        <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px">
        Use more cores for r.neighbors with large window sizes.
        <img src="img/lightbulb.png" style="width: 1.5em;margin: 0px"></p>
</section>


<section>
    <img src="img/exp3.png" class="stretch">
</section>





<!-- <section>
    <h2>Tiling approach: large overhead</h2>
    <p>Overhead from <strong>merging</strong> data and <strong>I/O</strong>:
    <br>
    <div style="font-size:80%;">
    <table>
        <tr>
          <th>process (12 cores, 2 billion cells)</th>
          <th>run time (MM:SS)</th>
          <th>speedup</th>
          <th>efficiency</th>
        </tr>
        <tr>
          <td>rasterization with GridModule</td>
          <td>00:35</td>
          <td>1.9</td>
          <td>16 %</td>
        </tr>
        <tr>
          <td>r.mapcalc.tiled (simple expression)</td>
          <td>00:39</td>
          <td>1.8</td>
          <td>15 %</td>
        </tr>
      </table>
    </div>
    <br><br>
    <p style="vertical-align: center;"><span style="font-size: 150%">&#10152</span>Use for large data
    <p style="vertical-align: center;"><span style="font-size: 150%">&#10152</span>Long running in-memory computations
    <p style="vertical-align: center;"><span style="font-size: 150%">&#10152</span> Use r.mapcalc.tiled for complex raster algebra expressions

</section> -->
<!-- 
<section>
    <h2>Tiling approach: tiling scheme</h2>
    <img class="fragment fade-out" data-fragment-index="1" src="img/tiling2.png" width="40%">
    <img class="fragment fade-right" data-fragment-index="1" src="img/tiling1.png" width="40%">
    <p class="fragment fade-right" data-fragment-index="1" style="vertical-align: center;"><span style="font-size: 150%">&#10152</span>Slice data horizontally
</section> -->



<section>
    <h2>Running GRASS in non-interactive session</h2>
    <p>Run module in existing mapset:
    <pre><code data-trim data-noescape class="nohighlight">
        grass ~/grassdata/US_albers/visibility <mark>--exec</mark> r.viewshed input=elevation ...
        </code></pre>
    <div class="fragment"><p>Run module in a newly created mapset:
    <pre><code data-trim data-noescape  class="nohighlight">
        grass <mark>-c</mark> ~/grassdata/US_albers/visibility --exec r.viewshed input=elevation ...
    </code></pre></p></div>
    <div class="fragment"><p>Run Python script in existing mapset:
    <pre><code data-trim data-noescape  class="nohighlight">
        grass ~/grassdata/US_albers/visibility --exec <mark>python viewshed_script.py</mark>
    </code></pre></p></div>
    <div class="fragment"><p>Run Python script in a temporary mapset:
    <pre><code data-trim data-noescape  class="nohighlight">
        grass <mark>--tmp-mapset</mark> ~/grassdata/US_albers/ --exec python viewshed_script.py
    </code></pre></p></div>
</section>

<section>
    <h2>Running GRASS commands in parallel</h2>
    <p>Generate commands:</p>
    <pre>jobs.sh<code data-trim data-noescape class="nohighlight">
grass ~/grassdata/nc_spm_08_grass7/analysis1 --exec python myscript.py 1
grass ~/grassdata/nc_spm_08_grass7/analysis2 --exec python myscript.py 2
grass ~/grassdata/nc_spm_08_grass7/analysis3 --exec python myscript.py 3
grass ~/grassdata/nc_spm_08_grass7/analysis4 --exec python myscript.py 4
grass ~/grassdata/nc_spm_08_grass7/analysis5 --exec python myscript.py 5
grass ~/grassdata/nc_spm_08_grass7/analysis6 --exec python myscript.py 6
...
</code></pre>

Run in parallel:
<pre><code data-trim data-noescape class="nohighlight">
parallel --jobs 8 < jobs.sh
</code></pre>
</section>

<section>
    <h2>Example: Scaling urban growth model</h2>
<img src="img/animation_CONUS.gif" class="stretch">
</section>


<section data-background="img/background2.png">
    <h2>Example: Scaling urban growth model</h2>
    <ul>
        <li>r.futures addon: FUTURES urban growth model </li>
        <li>computed at <strong>30-m</strong> resolution (16 billion cells) on HPC</li>
        <li><strong>50 stochastic</strong> runs annually from <strong>2020 to 2100</strong></li>
    </ul>
</section>


<section data-background="img/background2.png">
    <h2>CONUS data preprocessing</h2>
    <!-- Our goal was to get it computed in <em>reasonable time</em>... -->

    <br>
<!--    <p>CONUS (16 billion cells)-->
    <table>
        <tr>
          <th>GRASS tool</th>
          <th>window size</th>
          <th>cores</th>
          <th>serial time</th>
          <th>with OpenMP</th>
          
        </tr>
        <tr>
          <!-- <td>r.futures.devpressure</td> -->
          <td>r.slope.aspect</td>
          <td>3 x 3</td>
          <td>12</td>
          <td>37 min</td>
          <td>12 min</td>
          </tr>
          <tr>
            <td>r.mfilter</td>
            <td>61 x 61</td>
            <td>32</td>
            <td><span style="color: rgb(212, 0, 255)">4.9 days</span></td>
            <td>4.3 h</td>
        </tr>
      </table>
      <br><br>
</section>

<section>
    <h2>Parallelization by US states</h2>
    Tasks distributed across nodes using MPI (Message Passing Interface)
    <pre>jobs.txt<code data-trim class="language-bash hljs">
        grass state_1 --exec r.futures.simulation subregions=state_1 ...
        grass state_2 --exec r.futures.simulation subregions=state_2 ...
        grass state_3 --exec r.futures.simulation subregions=state_3 ...
    </code></pre>
        
    <img src="img/split-apply-merge.svg" class="stretch">
</section>


<section>
    <h2>Parallelization by US states</h2>

        <!-- <li>Need to know how much memory you need and assign number of cores per node accordingly</li> -->
        Gets tricky if some processes take much longer than others (looking at you, Texas)

    <img src="img/big-texas-map.jpg" class="stretch"><br>
        <p style="font-size:35%;">texasproud.com/how-big-is-texas-its-huge</p>
</section>


<section>
    <h2>Parallelization by US states</h2>
    
        <!-- <li>Need to know how much memory you need and assign number of cores per node accordingly</li> -->
        Gets tricky if some processes take much longer than others (looking at you, Texas)
    
    <img src="img/big-texas-map2.png" class="stretch"><br>
        <p style="font-size:35%;">texasproud.com/how-big-is-texas-its-huge</p>
</section>


<section>
    <img src="img/exp.webp" class="stretch">
</section>

<section>
    <h2>Resources</h2>
    <ul><li style="font-size: 90%"><a href="https://petrasovaa.github.io/FUTURES-CONUS-talk/foss4gNA2023.html">petrasovaa.github.io/FUTURES-CONUS-talk/foss4gNA2023.html</a></li>
        <li><a href="https://github.com/ncsu-geoforall-lab/grass-gis-workshop-foss4g-2023">GRASS FOSS4G NA 2023 workshop</a>
        <li><a href="https://github.com/ncsu-geoforall-lab/opengeohub-2023">OpenGeoHub 2023: Parallelization of geoprocessing workflows in GRASS GIS and Python</a></li>
        <li><a href="https://geospatial.ncsu.edu/research/FUTURES">FUTURES data and model</a> </li>    
        <li>GRASS <a href="https://grasswiki.osgeo.org/wiki/Mentoring_Program">Mentoring</a> and 
            <a href="https://grasswiki.osgeo.org/wiki/Student_Grants">Student Grants</a> programs</li>
    </ul>

    <p style="margin-top: 1em;">
        <img src="img/grassgis_logo_colorlogo_text_alphabg.png" width="17%">&nbsp;&nbsp;
        <img src="img/cga_ncsu.png" width="25%">&nbsp;&nbsp;
        <img src="img/NSF_logo.png" width="20%"></p>
    
</section>






            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script src="plugin/math/math.js"></script>
        <script src="plugin/chalkboard/plugin.js"></script>
        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                hash: true,
                // Display controls in the bottom right corner
                controls: true,

                // Display a presentation progress bar
                progress: false,

                center: true,

                // Display the page number of the current slide
                slideNumber: false,

                // Enable the slide overview mode
                overview: true,

                // Turns fragments on and off globally
                fragments: true,

                // The "normal" size of the presentation, aspect ratio will be preserved
                // when the presentation is scaled to fit different resolutions. Can be
                // specified using percentage units.
                // width: 960,
                // height: 700,

                // Factor of the display size that should remain empty around the content
                margin: 0.05,  // increase?

                // Bounds for smallest/largest possible scale to apply to content
                minScale: 0.5,
                maxScale: 5.0,

                // Push each slide change to the browser history
                history: true,
                // Enable keyboard shortcuts for navigation
                keyboard: true,

                // Vertical centering of slides
                center: true,

                // Enables touch navigation on devices with touch input
                touch: true,

                // Loop the presentation
                loop: false,
                // Flags if the presentation is running in an embedded mode,
                // i.e. contained within a limited portion of the screen
                embedded: false,

                // Number of milliseconds between automatically proceeding to the
                // next slide, disabled when set to 0, this value can be overwritten
                // by using a data-autoslide attribute on your slides
                autoSlide: 0,

                // Stop auto-sliding after user input
                autoSlideStoppable: true,

                // Enable slide navigation via mouse wheel
                mouseWheel: true,

                // Hides the address bar on mobile devices
                hideAddressBar: true,

                // Opens links in an iframe preview overlay
                previewLinks: false,

                // Slide transition
                transition: 'none', // default/none/slide/concave/convex/zoom

                // Transition speed
                transitionSpeed: 'default', // default/fast/slow

                // Transition style for full page slide backgrounds
                backgroundTransition: 'none', // default/none/slide/concave/convex/zoom

                // Number of slides away from the current that are visible
                viewDistance: 3,

                // Parallax background image
                //parallaxBackgroundImage: '', // e.g. "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'"

                // Parallax background size
                //parallaxBackgroundSize: '' // CSS syntax, e.g. "2100px 900px"

                chalkboard: {
                    boardmarkerWidth: 3,
                    chalkWidth: 7,
                    chalkEffect: 1.0,
                    src: null,
                    readOnly: undefined,
                    toggleChalkboardButton: true,
                    toggleNotesButton: true,
                    boardmarkers : [
                        { color: 'rgba(220,20,60,1)', cursor: 'url(' + path + 'img/boardmarker-red.png), auto'},
                        { color: 'rgba(255,140,0,1)', cursor: 'url(' + path + 'img/boardmarker-orange.png), auto'},
                    ]
                },

                math: {
                    mathjax: 'https://cdn.jsdelivr.net/gh/mathjax/mathjax@2.7.8/MathJax.js',
                    config: 'TeX-AMS_HTML-full',
                    // pass other options into `MathJax.Hub.Config()`
                    TeX: { Macros: { RR: "{\\bf R}" } }
                },

                plugins: [
                    RevealMath,
                    RevealHighlight,
                    RevealMarkdown,
                    RevealNotes,
                    RevealChalkboard
                ]
            });
        </script>
    </body>
</html>
